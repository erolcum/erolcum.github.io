---
layout: post
title: PB -5- Arduino DHT11 sensörü
---

Arduino'dan gelen sıcaklık ve nem bilgisini grafiksel (chart) olarak gösteriyoruz.<br><br>

![image](https://github.com/user-attachments/assets/3afcfb49-975b-40b8-b9d8-325bee438ffd)<br><br>

Aşağıdaki kodu Arduino’ya yüklüyoruz.. Öncesinde, kütüphane yöneticisi ile DHT-sensor-library ve Adafruit-Unified-Sensor kütüphanelerini yüklüyoruz.<br><br>

```arduino
#include <DHT.h>
#define DHTPIN 2 //DHT pin 
#define DHTTYPE DHT11 
DHT dht(DHTPIN, DHTTYPE);

void setup() {
  Serial.begin(19200);
  dht.begin();
}

void loop() {
  float h = dht.readHumidity(); // Nem 
  float t = dht.readTemperature(); // Sıcaklık 
  Serial.print("TP"); // header
  Serial.print(t);
  Serial.print("@"); // separator
  Serial.println(h); // println sonuna CRLF basar
  delay(250);
}
```
<br>
Bu kodu Arduino'ya yükledikten sonra, her 250 milisaniyede bir sıcaklık ve nem bilgisi TP24.30@55 biçiminde Purebasic'e iletilecektir. Sensör sıcaklığı küsuratlı veriyor ama nemi tamsayı olarak veriyor. Forumda dolanırken resimde olduğu gibi sinüs, cosinüs veya başka matematiksel grafikleri zamana bağlı olarak çizebilen bir kod parçası buldum. graph100 isimli forum kullanıcısı yazmış, sanırım fransız kendisi. <br><br>

![image](https://github.com/user-attachments/assets/7120b727-d2b3-4821-9ea8-0b3499445430)<br><br>

Kodu biraz oynayarak, aşağıdaki hale getirdim. Kodu **chart.pb** olarak boş bir dizine kaydedin. <br>

```purebasic
; https://www.purebasic.fr/english/viewtopic.php?t=60077&start=18
; chart module from user : graph100 in forum
DeclareModule Graph
  
  Structure Graph_pt_point_d
    x.d
    y.d
  EndStructure
  
  Structure Graph_pt
    *graph.Graph
    color.l
    line.b
    List pt.d()
  EndStructure
  
  Structure Graph
    pos.Graph_pt_point_d
    dimension.POINT
    nb_point.l
    List list_des_pt.Graph_pt()
    maxi.d
    mini.d
    ratio_w.d
    ratio_h.d
    Name.s
  EndStructure
  
  Declare.i Graph_Init(x, y, width, height, nb_point, Name.s = "")
  Declare.i Graph_AddSerie(*graph.Graph, color.l, Line.b = #False)
  Declare.i Graph_FreeSerie(*graph.Graph, *adresse_serie)
  Declare Graph_AddPoint(*adresse_serie.Graph_pt, value.d)
  Declare Graph_Draw(*graph.Graph)
EndDeclareModule

Module Graph
  
  Procedure.d Maxi_delta(value.d, delta.d)
    If delta = 0
      ProcedureReturn Round(value, #PB_Round_Up) + 0.5
    Else
      p10.d = Pow(10, Round(Log10(Abs(delta)), #PB_Round_Down))
      ProcedureReturn Round(value / p10, #PB_Round_Up) * p10
    EndIf
  EndProcedure
  
  Procedure.d Mini_delta(value.d, delta.d)
    If delta = 0
      ProcedureReturn Round(value, #PB_Round_Down) - 0.5
    Else
      p10.d = Pow(10, Round(Log10(Abs(delta)), #PB_Round_Down))
      ProcedureReturn Round(value / p10, #PB_Round_Down) * p10
    EndIf
  EndProcedure
  
  Procedure.i Graph_Init(x, y, width, height, nb_point, Name.s = "")
    *graph.Graph = AllocateMemory(SizeOf(Graph))
    InitializeStructure(*graph, Graph)
    *graph\pos\x = x
    *graph\pos\y = y
    *graph\dimension\x = width
    *graph\dimension\y = height
    *graph\nb_point = nb_point
    *graph\ratio_w = *graph\dimension\x / *graph\nb_point
    *graph\Name = Name
    ProcedureReturn *graph
  EndProcedure
  
  Procedure.i Graph_AddSerie(*graph.Graph, color.l, Line.b = #False) ; serinin adresini döndürür
    *new_serie = AddElement(*graph\list_des_pt())
    InitializeStructure(*new_serie, Graph_pt)
    *graph\list_des_pt()\color = color
    *graph\list_des_pt()\graph = *graph
    *graph\list_des_pt()\line = Line
    ProcedureReturn *new_serie
  EndProcedure
  
  Procedure.i Graph_FreeSerie(*graph.Graph, *adresse_serie) 
    ChangeCurrentElement(*graph\list_des_pt(), *adresse_serie)
    FreeList(*graph\list_des_pt()\pt())
    DeleteElement(*graph\list_des_pt())
  EndProcedure
  
  Procedure Graph_AddPoint(*adresse_serie.Graph_pt, value.d)
    LastElement(*adresse_serie\pt())
    AddElement(*adresse_serie\pt())
    *adresse_serie\pt() = value
    
    If ListSize(*adresse_serie\pt()) > *adresse_serie\graph\nb_point
      FirstElement(*adresse_serie\pt())
      DeleteElement(*adresse_serie\pt())
    EndIf
  EndProcedure
  
  Procedure Graph_Draw(*graph.Graph)
    Line(*graph\pos\x - 1, *graph\pos\y - 1, *graph\dimension\x + 2, 1, #Green)
    Line(*graph\pos\x - 1, *graph\pos\y - 1, 1, *graph\dimension\y + 2, #Green)
    Line(*graph\pos\x - 1, *graph\pos\y - 1 + *graph\dimension\y + 2, *graph\dimension\x + 2, 1, #Green)
    Line(*graph\pos\x - 1 + *graph\dimension\x + 2, *graph\pos\y - 1, 1, *graph\dimension\y + 2, #Green)
    
    j = 4
    For i = 69 To 621 Step 69
      Line(*graph\pos\x + i, *graph\pos\y  + *graph\dimension\y - 3, 1, 10, #Green)
      DrawText(*graph\pos\x + i - 6, *graph\pos\y  + *graph\dimension\y + 8, Str(j), #Green, 0)
      j + 4 
    Next
    DrawText(*graph\pos\x + 640, *graph\pos\y  + *graph\dimension\y + 8, "secs", #Green, 0)
    
    If *graph\Name
      Protected titre$ = " " + *graph\Name + " "
      Protected w = TextWidth(titre$), h = TextHeight(titre$)
      Protected x.d = *graph\pos\x + *graph\dimension\x / 2 - w / 2, y.d = *graph\pos\y - h / 2
      DrawText(x ,y , titre$, #Green)
      Line(x - 1, y - 1, w + 1, 1, #Green)
      Line(x - 1, y - 1, 1, h + 1, #Green)
      Line(x - 1, y - 1 + h + 1, w + 2, 1, #Green)
      Line(x - 1 + w + 1, y - 1, 1, h + 2, #Green)
    EndIf
    
    DrawText(*graph\pos\x + *graph\dimension\x + 2, *graph\pos\y - 1, StrD(*graph\maxi), #Green)
    DrawText(*graph\pos\x + *graph\dimension\x + 2, *graph\pos\y - 1 + *graph\dimension\y +
                                                    2 - TextHeight(" "), StrD(*graph\mini), #Green)
    *graph\ratio_h = *graph\dimension\y / (*graph\maxi - *graph\mini)
    mini.d = *graph\mini
    
    If Sign(*graph\maxi) <> Sign(*graph\mini)
      Line(*graph\pos\x, *graph\pos\y + *graph\dimension\y + mini * *graph\ratio_h, *graph\dimension\x, 1, #Green)
      DrawText(*graph\pos\x + *graph\dimension\x + 2, *graph\pos\y + *graph\dimension\y +
                                                      mini * *graph\ratio_h - TextHeight(" ") / 2, "0", #Green)
    EndIf
    
    *graph\maxi = -Infinity()
    *graph\mini = Infinity()
    
    ForEach *graph\list_des_pt()
      index = 0
      If *graph\list_des_pt()\line = #False
        ForEach *graph\list_des_pt()\pt()
          If *graph\list_des_pt()\pt() > *graph\maxi : *graph\maxi = *graph\list_des_pt()\pt() : EndIf
          If *graph\list_des_pt()\pt() < *graph\mini : *graph\mini = *graph\list_des_pt()\pt() : EndIf
          Line(*graph\pos\x + index * *graph\ratio_w, *graph\pos\y + 
                                                      *graph\dimension\y - (*graph\list_des_pt()\pt() - mini)**graph\ratio_h,
               1, 1, *graph\list_des_pt()\color)
          index + 1
        Next
        
      Else
        *adr.Double = FirstElement(*graph\list_des_pt()\pt())
        old_x.d = *graph\pos\x + index * *graph\ratio_w
        old_y.d = *graph\pos\y + *graph\dimension\y - (*graph\list_des_pt()\pt() - mini) * *graph\ratio_h
        ForEach *graph\list_des_pt()\pt()
          If *graph\list_des_pt()\pt() > *graph\maxi : *graph\maxi = *graph\list_des_pt()\pt() : EndIf
          If *graph\list_des_pt()\pt() < *graph\mini : *graph\mini = *graph\list_des_pt()\pt() : EndIf
          x.d = *graph\pos\x + index * *graph\ratio_w
          y.d = *graph\pos\y + *graph\dimension\y - (*graph\list_des_pt()\pt() - mini) * *graph\ratio_h
          LineXY(x, y, old_x, old_y, *graph\list_des_pt()\color)
          old_x = x
          old_y = y
          index + 1
        Next
      EndIf
      
      If LastElement(*graph\list_des_pt()\pt())
        DrawText(*graph\pos\x + *graph\dimension\x + 2,
                 *graph\pos\y + *graph\dimension\y-(*graph\list_des_pt()\pt() - mini) * *graph\ratio_h - TextHeight(" ") / 2, 
                 StrD(*graph\list_des_pt()\pt()), *graph\list_des_pt()\color)
      EndIf
    Next
    
    delta.d = *graph\maxi - *graph\mini
    *graph\maxi = Maxi_delta(*graph\maxi, delta)
    *graph\mini = Mini_delta(*graph\mini, delta)
    If delta = 0 : delta = 1 : EndIf
    
  EndProcedure
EndModule

```





